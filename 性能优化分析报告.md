# VRåº”ç”¨æ€§èƒ½ä¼˜åŒ–åˆ†ææŠ¥å‘Š

> é¡¹ç›®ï¼šPICO XR è¿œç¨‹æ“æ§åº”ç”¨
> åˆ†ææ—¶é—´ï¼š2025-12-12
> ç›®æ ‡å¹³å°ï¼šAndroid (PICO VR)
> ç›®æ ‡å¸§ç‡ï¼š90 FPS (11.1ms/å¸§)

---

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [VRæ€§èƒ½åŸºå‡†ä¸è¦æ±‚](#vræ€§èƒ½åŸºå‡†ä¸è¦æ±‚)
3. [ä¸¥é‡æ€§èƒ½é—®é¢˜](#ä¸¥é‡æ€§èƒ½é—®é¢˜)
4. [ä¸­ç­‰æ€§èƒ½é—®é¢˜](#ä¸­ç­‰æ€§èƒ½é—®é¢˜)
5. [è½»å¾®æ€§èƒ½é—®é¢˜](#è½»å¾®æ€§èƒ½é—®é¢˜)
6. [ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ](#ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ)
7. [æ€§èƒ½æµ‹è¯•å»ºè®®](#æ€§èƒ½æµ‹è¯•å»ºè®®)

---

## æ‰§è¡Œæ‘˜è¦

### å½“å‰æ€§èƒ½ç“¶é¢ˆ

ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°**3ä¸ªä¸¥é‡æ€§èƒ½é—®é¢˜**å¯èƒ½å¯¼è‡´å¸§ç‡ä¸‹é™å’Œå¡é¡¿ï¼š

1. **æ¯å¸§å‘é€HTTPè¯·æ±‚** - DataTracking.csåœ¨90Hzä¸‹æ¯ç§’åˆ›å»º90ä¸ªåç¨‹
2. **é«˜é¢‘è½®è¯¢ç½‘ç»œ** - HapticMessageReceiver.csæ¯0.1ç§’è½®è¯¢ä¸€æ¬¡æœåŠ¡å™¨
3. **UIé¢‘ç¹é‡å»º** - VRLogDisplay.csæ¯æ¡æ—¥å¿—éƒ½é‡å»ºæ•´ä¸ªå­—ç¬¦ä¸²

### é¢„æœŸä¼˜åŒ–æ”¶ç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| CPUå ç”¨ | é«˜ | ä½ | â†“ 30-50% |
| GCåˆ†é…/ç§’ | é«˜ | ä½ | â†“ 60-80% |
| ç½‘ç»œè¯·æ±‚/ç§’ | ~100æ¬¡ | ~30æ¬¡ | â†“ 70% |
| å¸§æ—¶é—´ç¨³å®šæ€§ | æ³¢åŠ¨å¤§ | ç¨³å®š | æ˜¾è‘—æ”¹å–„ |

---

## VRæ€§èƒ½åŸºå‡†ä¸è¦æ±‚

### PICOè®¾å¤‡æ€§èƒ½ç‰¹å¾

```
åˆ·æ–°ç‡ï¼š90Hz (éƒ¨åˆ†è®¾å¤‡æ”¯æŒ120Hz)
å¸§é¢„ç®—ï¼š11.1ms/å¸§ @ 90Hz
CPUï¼šéªé¾™XRç³»åˆ— (ç§»åŠ¨SoCï¼ŒåŠŸè€—å—é™)
å†…å­˜ï¼š6-8GB (ä¸ç³»ç»Ÿå…±äº«)
```

### VRæ€§èƒ½é»„é‡‘æ³•åˆ™

1. **ç¨³å®šå¸§ç‡ä¼˜äºé«˜å¸§ç‡** - å¸§æ—¶é—´æ³¢åŠ¨ä¼šå¯¼è‡´æ™•åŠ¨ç—‡
2. **GCæš‚åœå¿…é¡»<1ms** - é•¿GCä¼šå¯¼è‡´ä¸¢å¸§
3. **é¿å…ä¸»çº¿ç¨‹é˜»å¡** - ç½‘ç»œ/IOæ“ä½œå¼‚æ­¥åŒ–
4. **å†…å­˜åˆ†é…æœ€å°åŒ–** - ç§»åŠ¨VRè®¾å¤‡å†…å­˜å¸¦å®½æœ‰é™

### Unity VRæ€§èƒ½æŒ‡æ ‡

```csharp
// å…³é”®æ€§èƒ½è®¡æ•°å™¨
Time.deltaTime        // åº”ç¨³å®šåœ¨ ~11.1ms
Time.smoothDeltaTime  // å¹³æ»‘å¸§æ—¶é—´ï¼Œç”¨äºæ£€æµ‹æ³¢åŠ¨
Profiler.GetTotalAllocatedMemoryLong()  // GCå‹åŠ›æŒ‡æ ‡
UnityEngine.Rendering.FrameTimingManager  // GPUå¸§æ—¶é—´
```

---

## ä¸¥é‡æ€§èƒ½é—®é¢˜

### ğŸ”´ é—®é¢˜1ï¼šæ¯å¸§å‘é€ç½‘ç»œè¯·æ±‚ (æœ€ä¸¥é‡)

**æ–‡ä»¶ï¼š** `DataTracking.cs:63-80`

#### é—®é¢˜åˆ†æ

```csharp
private void Update()
{
    // æ¯å¸§æ‰§è¡Œ (90Hz)
    if (uiController != null)
    {
        serverUrl = "https://" + uiController.serverBaseUrl + "/poseData";  // âŒ æ¯å¸§å­—ç¬¦ä¸²æ‹¼æ¥
    }

    CollectAllDeviceData();
    SendDataToServer();  // âŒ æ¯å¸§å¯åŠ¨æ–°åç¨‹ï¼
}

private void SendDataToServer()
{
    // ...
    StartCoroutine(PostDataToServer(json));  // âŒ æ¯å¸§åˆ›å»ºåç¨‹
}

private IEnumerator PostDataToServer(string jsonData)
{
    var request = new UnityEngine.Networking.UnityWebRequest(url, "POST");  // âŒ æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
    // ...
}
```

#### æ€§èƒ½å½±å“

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| æ¯ç§’90ä¸ªåç¨‹åˆ›å»º | GCå‹åŠ›ã€CPUå¼€é”€ | âš ï¸âš ï¸âš ï¸ ä¸¥é‡ |
| æ¯ç§’90ä¸ªUnityWebRequestå¯¹è±¡ | å†…å­˜åˆ†é…ã€ç½‘ç»œæ ˆå‹åŠ› | âš ï¸âš ï¸âš ï¸ ä¸¥é‡ |
| æ¯ç§’90æ¬¡JSONåºåˆ—åŒ– | CPUå ç”¨ã€å­—ç¬¦ä¸²åˆ†é… | âš ï¸âš ï¸ ä¸­ç­‰ |
| æœåŠ¡å™¨æ¯ç§’æ¥æ”¶90ä¸ªè¯·æ±‚ | ç½‘ç»œæ‹¥å¡ã€æœåŠ¡å™¨å‹åŠ› | âš ï¸âš ï¸âš ï¸ ä¸¥é‡ |

#### VRå¼€å‘è§†è§’

```
VRè¿½è¸ªæ•°æ®ç‰¹ç‚¹ï¼š
- é«˜é¢‘ç‡ï¼š90Hzé‡‡æ ·ç¡®ä¿ä½å»¶è¿Ÿ
- é«˜å†—ä½™ï¼šç›¸é‚»å¸§æ•°æ®ç›¸ä¼¼åº¦>95%
- å®æ—¶æ€§ï¼šå»¶è¿Ÿæ•æ„Ÿï¼Œä½†ä¸éœ€è¦æ¯å¸§éƒ½ä¼ è¾“

ä¼˜åŒ–ç­–ç•¥ï¼š
âœ“ æœ¬åœ°é«˜é¢‘é‡‡é›† (90Hz) - ä¿è¯è¾“å…¥å“åº”æ€§
âœ“ é™é¢‘å‘é€ (30-60Hz) - å‡å°‘ç½‘ç»œå¼€é”€
âœ“ å®¢æˆ·ç«¯æ’å€¼ - å¹³æ»‘è¿œç¨‹æ˜¾ç¤º
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå›ºå®šé¢‘ç‡èŠ‚æµï¼ˆæ¨èç”¨äºç¨³å®šä¼ è¾“ï¼‰**

```csharp
public class DataTracking : MonoBehaviour
{
    [Header("ç½‘ç»œæ€§èƒ½")]
    [Tooltip("å‘é€é¢‘ç‡ (Hz) - å»ºè®®30-60")]
    [Range(10, 90)]
    public int sendFrequency = 30;

    private float sendInterval;
    private float lastSendTime = 0f;
    private UnityWebRequest currentRequest;  // âœ… å¤ç”¨å¯¹è±¡

    private void Start()
    {
        sendInterval = 1f / sendFrequency;
    }

    private void Update()
    {
        // âœ… æœ¬åœ°é‡‡é›†ä»ä¿æŒ90Hzï¼ˆç”¨äºæœ¬åœ°é¢„æµ‹/æ’å€¼ï¼‰
        CollectAllDeviceData();

        // âœ… å‘é€æŒ‰å›ºå®šé¢‘ç‡èŠ‚æµ
        if (Time.time - lastSendTime >= sendInterval)
        {
            lastSendTime = Time.time;
            SendDataToServer();
        }
    }

    private void SendDataToServer()
    {
        // âœ… å¦‚æœä¸Šä¸€ä¸ªè¯·æ±‚è¿˜åœ¨è¿›è¡Œï¼Œè·³è¿‡æœ¬æ¬¡å‘é€ï¼ˆé¿å…å †ç§¯ï¼‰
        if (currentRequest != null && !currentRequest.isDone)
        {
            if (enableDebugLog)
                Debug.LogWarning("[DataTracking] ä¸Šä¸€ä¸ªè¯·æ±‚æœªå®Œæˆï¼Œè·³è¿‡æœ¬æ¬¡å‘é€");
            return;
        }

        var data = BuildSendData();
        string json = JsonUtility.ToJson(data, false);  // âœ… ç”Ÿäº§ç¯å¢ƒå…³é—­pretty print

        StartCoroutine(PostDataToServer(json));
    }

    private IEnumerator PostDataToServer(string jsonData)
    {
        // âœ… å¤ç”¨æˆ–åˆ›å»ºæ–°è¯·æ±‚
        if (currentRequest != null)
        {
            currentRequest.Dispose();
        }

        currentRequest = new UnityWebRequest(serverUrl, "POST");
        byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(jsonData);
        currentRequest.uploadHandler = new UploadHandlerRaw(bodyRaw);
        currentRequest.downloadHandler = new DownloadHandlerBuffer();
        currentRequest.SetRequestHeader("Content-Type", "application/json");
        currentRequest.certificateHandler = new CustomCertificateHandler();
        currentRequest.timeout = 1;  // âœ… è®¾ç½®è¶…æ—¶é¿å…é˜»å¡

        yield return currentRequest.SendWebRequest();

        // é”™è¯¯å¤„ç†...
    }

    private void OnDestroy()
    {
        // âœ… æ¸…ç†èµ„æº
        if (currentRequest != null)
        {
            currentRequest.Dispose();
            currentRequest = null;
        }
    }
}
```

**æ–¹æ¡ˆBï¼šè‡ªé€‚åº”é¢‘ç‡ï¼ˆæ¨èç”¨äºä¼˜åŒ–å¸¦å®½ï¼‰**

```csharp
// æ ¹æ®æ•°æ®å˜åŒ–é‡åŠ¨æ€è°ƒæ•´å‘é€é¢‘ç‡
public class AdaptiveDataTracking : MonoBehaviour
{
    [Header("è‡ªé€‚åº”å‘é€")]
    public float maxSendFrequency = 60f;     // æœ€å¤§60Hz
    public float minSendFrequency = 10f;     // æœ€å°10Hz
    public float motionThreshold = 0.01f;    // è¿åŠ¨é˜ˆå€¼ï¼ˆç±³/ç§’ï¼‰

    private SendVRData lastSentData;
    private float currentSendInterval;

    private void Update()
    {
        CollectAllDeviceData();

        // è®¡ç®—è¿åŠ¨å¼ºåº¦
        float motionIntensity = CalculateMotionIntensity();

        // åŠ¨æ€è°ƒæ•´å‘é€é¢‘ç‡ï¼šè¿åŠ¨å¿«æ—¶é«˜é¢‘ï¼Œé™æ­¢æ—¶ä½é¢‘
        float targetFrequency = Mathf.Lerp(
            minSendFrequency,
            maxSendFrequency,
            Mathf.Clamp01(motionIntensity / motionThreshold)
        );
        currentSendInterval = 1f / targetFrequency;

        // å‘é€é€»è¾‘...
    }

    private float CalculateMotionIntensity()
    {
        // è®¡ç®—å¤´æ˜¾é€Ÿåº¦å¤§å°
        float headSpeed = headCache.velocity.magnitude;

        // è®¡ç®—æ‰‹æŸ„é€Ÿåº¦å¤§å°
        float leftSpeed = leftCache.velocity.magnitude;
        float rightSpeed = rightCache.velocity.magnitude;

        // è¿”å›æœ€å¤§é€Ÿåº¦
        return Mathf.Max(headSpeed, leftSpeed, rightSpeed);
    }
}
```

**æ–¹æ¡ˆCï¼šWebSocketé•¿è¿æ¥ï¼ˆæ¨èç”¨äºä½å»¶è¿Ÿåœºæ™¯ï¼‰**

```csharp
// ä½¿ç”¨WebSocketæ›¿ä»£HTTPè½®è¯¢
// éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼šhttps://github.com/endel/NativeWebSocket

using NativeWebSocket;

public class WebSocketDataTracking : MonoBehaviour
{
    private WebSocket websocket;
    private bool isConnected = false;

    async void Start()
    {
        websocket = new WebSocket("wss://localhost:5000/ws");

        websocket.OnOpen += () => {
            Debug.Log("âœ… WebSocketå·²è¿æ¥");
            isConnected = true;
        };

        websocket.OnError += (e) => {
            Debug.LogError($"âŒ WebSocketé”™è¯¯: {e}");
        };

        websocket.OnClose += (e) => {
            Debug.Log("WebSocketå·²å…³é—­");
            isConnected = false;
        };

        await websocket.Connect();
    }

    private void Update()
    {
        #if !UNITY_WEBGL || UNITY_EDITOR
        websocket?.DispatchMessageQueue();  // å¿…é¡»åœ¨ä¸»çº¿ç¨‹è°ƒç”¨
        #endif

        CollectAllDeviceData();

        // å›ºå®š30Hzå‘é€
        if (Time.time - lastSendTime >= 1f / 30f && isConnected)
        {
            lastSendTime = Time.time;
            SendDataViaWebSocket();
        }
    }

    async void SendDataViaWebSocket()
    {
        var data = BuildSendData();
        string json = JsonUtility.ToJson(data, false);

        if (websocket.State == WebSocketState.Open)
        {
            await websocket.SendText(json);
        }
    }

    private async void OnDestroy()
    {
        if (websocket != null)
        {
            await websocket.Close();
        }
    }
}
```

#### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | CPUå ç”¨ | ç½‘ç»œå¼€é”€ | å»¶è¿Ÿ | å®ç°éš¾åº¦ |
|------|---------|----------|------|----------|
| åŸå§‹ä»£ç  | é«˜ (90 req/s) | é«˜ | ä½ | - |
| å›ºå®šèŠ‚æµ | ä½ (30 req/s) | ä¸­ | ä½ | â­ ç®€å• |
| è‡ªé€‚åº” | ä½-ä¸­ (10-60) | ä½-ä¸­ | ä½ | â­â­ ä¸­ç­‰ |
| WebSocket | å¾ˆä½ | å¾ˆä½ | æä½ | â­â­â­ å¤æ‚ |

---

### ğŸ”´ é—®é¢˜2ï¼šé«˜é¢‘ç½‘ç»œè½®è¯¢

**æ–‡ä»¶ï¼š** `HapticMessageReceiver.cs:43-60`

#### é—®é¢˜åˆ†æ

```csharp
private void Update()
{
    if (!enableMessageReceiving) return;

    // âŒ æ¯0.1ç§’è½®è¯¢ä¸€æ¬¡
    if (Time.time - lastPollTime >= pollInterval && !isPolling)
    {
        lastPollTime = Time.time;
        StartCoroutine(PollMessages());  // âŒ æ¯ç§’10ä¸ªåç¨‹
    }
}

private IEnumerator PollMessages()
{
    isPolling = true;

    var request = new UnityWebRequest(url, "POST");  // âŒ æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
    // ...
    yield return request.SendWebRequest();
    // ...

    isPolling = false;
}
```

#### æ€§èƒ½å½±å“

```
é¢‘ç‡ï¼šæ¯ç§’10æ¬¡è¯·æ±‚
GCåˆ†é…ï¼šæ¯æ¬¡ ~2KB (UnityWebRequest + DownloadHandler)
æ€»åˆ†é…ï¼š20KB/ç§’ = 1.2MB/åˆ†é’Ÿ

é—®é¢˜ï¼š
1. é«˜é¢‘è½®è¯¢å¯¼è‡´CPUå’Œç½‘ç»œèµ„æºæµªè´¹
2. å³ä½¿æ²¡æœ‰æ¶ˆæ¯ä¹ŸæŒç»­è½®è¯¢
3. ç§»åŠ¨è®¾å¤‡ç”µæ± æ¶ˆè€—é«˜
```

#### Unityç½‘ç»œæœ€ä½³å®è·µ

```csharp
// Unityå®˜æ–¹æ¨èï¼š
// 1. ä½¿ç”¨UnityWebRequestAsyncOperationä»£æ›¿åç¨‹
// 2. å®ç°è¿æ¥æ± å¤ç”¨UnityWebRequest
// 3. ä½¿ç”¨é•¿è½®è¯¢(Long Polling)æˆ–Server-Sent Events
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šé™ä½è½®è¯¢é¢‘ç‡ + æŒ‡æ•°é€€é¿**

```csharp
public class OptimizedHapticReceiver : MonoBehaviour
{
    [Header("è½®è¯¢ç­–ç•¥")]
    public float baseInterval = 0.5f;        // åŸºç¡€é—´éš”0.5ç§’
    public float maxInterval = 5f;           // æœ€å¤§é—´éš”5ç§’
    public float backoffMultiplier = 1.5f;   // é€€é¿å€æ•°

    private float currentInterval;
    private int consecutiveEmptyPolls = 0;

    private void Awake()
    {
        currentInterval = baseInterval;
    }

    private void Update()
    {
        if (!enableMessageReceiving) return;

        if (Time.time - lastPollTime >= currentInterval && !isPolling)
        {
            lastPollTime = Time.time;
            StartCoroutine(PollMessages());
        }
    }

    private IEnumerator PollMessages()
    {
        isPolling = true;

        // ç½‘ç»œè¯·æ±‚é€»è¾‘...

        if (request.result == UnityWebRequest.Result.Success)
        {
            string json = request.downloadHandler.text;

            if (string.IsNullOrEmpty(json) || json == "{}" || json.Contains("\"msg\":[]"))
            {
                // âœ… æ— æ¶ˆæ¯ï¼šå¢åŠ è½®è¯¢é—´éš”
                consecutiveEmptyPolls++;
                currentInterval = Mathf.Min(
                    baseInterval * Mathf.Pow(backoffMultiplier, consecutiveEmptyPolls),
                    maxInterval
                );

                if (verboseLogging)
                    Debug.Log($"ğŸ“­ æ— æ¶ˆæ¯ï¼Œé™ä½é¢‘ç‡è‡³ {currentInterval:F2}ç§’");
            }
            else
            {
                // âœ… æœ‰æ¶ˆæ¯ï¼šæ¢å¤é«˜é¢‘è½®è¯¢
                consecutiveEmptyPolls = 0;
                currentInterval = baseInterval;

                ProcessMessage(json);
            }
        }

        request.Dispose();
        isPolling = false;
    }
}
```

**æ–¹æ¡ˆBï¼šé•¿è½®è¯¢ï¼ˆLong Pollingï¼‰**

```csharp
// æœåŠ¡å™¨ç«¯æ”¯æŒé•¿è½®è¯¢ï¼šè¯·æ±‚æŒ‚èµ·ç›´åˆ°æœ‰æ¶ˆæ¯æˆ–è¶…æ—¶
public class LongPollingReceiver : MonoBehaviour
{
    [Header("é•¿è½®è¯¢é…ç½®")]
    public float longPollTimeout = 30f;  // æœåŠ¡å™¨æŒ‚èµ·30ç§’

    private IEnumerator PollMessages()
    {
        isPolling = true;

        var request = new UnityWebRequest(url, "POST");
        request.downloadHandler = new DownloadHandlerBuffer();
        request.timeout = (int)longPollTimeout + 5;  // å®¢æˆ·ç«¯è¶…æ—¶ç•¥é•¿äºæœåŠ¡å™¨

        // âœ… è¯·æ±‚ä¼šåœ¨æœåŠ¡å™¨ç«¯æŒ‚èµ·ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯æˆ–è¶…æ—¶
        yield return request.SendWebRequest();

        if (request.result == UnityWebRequest.Result.Success)
        {
            string json = request.downloadHandler.text;
            if (!string.IsNullOrEmpty(json))
            {
                ProcessMessage(json);
            }
        }

        request.Dispose();
        isPolling = false;

        // âœ… ç«‹å³å‘èµ·ä¸‹ä¸€æ¬¡é•¿è½®è¯¢ï¼ˆæ— å»¶è¿Ÿï¼‰
        if (enableMessageReceiving)
        {
            StartCoroutine(PollMessages());
        }
    }
}
```

**æ–¹æ¡ˆCï¼šWebSocketæ¨é€ï¼ˆæœ€ä¼˜ï¼‰**

```csharp
using NativeWebSocket;

public class WebSocketHapticReceiver : MonoBehaviour
{
    private WebSocket websocket;

    async void Start()
    {
        websocket = new WebSocket("wss://localhost:5000/haptic");

        websocket.OnMessage += (bytes) => {
            // âœ… æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼Œæ— éœ€è½®è¯¢
            string json = System.Text.Encoding.UTF8.GetString(bytes);
            ProcessMessage(json);
        };

        await websocket.Connect();
    }

    private void Update()
    {
        // âœ… åªéœ€åˆ†å‘æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ— éœ€å‘èµ·è¯·æ±‚
        #if !UNITY_WEBGL || UNITY_EDITOR
        websocket?.DispatchMessageQueue();
        #endif
    }
}
```

#### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | è¯·æ±‚é¢‘ç‡ | å»¶è¿Ÿ | CPUå ç”¨ | ç”µæ± æ¶ˆè€— |
|------|----------|------|---------|----------|
| åŸå§‹(0.1s) | 10 req/s | 50ms | é«˜ | é«˜ |
| å›ºå®š0.5s | 2 req/s | 250ms | ä½ | ä½ |
| æŒ‡æ•°é€€é¿ | 0.2-2 req/s | è‡ªé€‚åº” | å¾ˆä½ | å¾ˆä½ |
| é•¿è½®è¯¢ | 0.033 req/s | ä½ | ä½ | ä½ |
| WebSocket | 0 req/s | æä½ | æä½ | æä½ |

---

### ğŸ”´ é—®é¢˜3ï¼šUIé¢‘ç¹é‡å»º

**æ–‡ä»¶ï¼š** `VRLogDisplay.cs:68-80`

#### é—®é¢˜åˆ†æ

```csharp
void HandleLog(string message, string stackTrace, LogType type)
{
    string colorCode = type == LogType.Error ? "red" : type == LogType.Warning ? "yellow" : "white";
    string log = $"<color={colorCode}>{message}</color>";  // âŒ å­—ç¬¦ä¸²åˆ†é…

    logs.Enqueue(log);
    while (logs.Count > maxLines)
    {
        logs.Dequeue();
    }

    logText.text = string.Join("\n", logs);  // âŒ æ¯æ¬¡é‡å»ºæ•´ä¸ªå­—ç¬¦ä¸²ï¼
}
```

#### æ€§èƒ½å½±å“ï¼ˆé«˜é¢‘æ—¥å¿—åœºæ™¯ï¼‰

```
å‡è®¾åœºæ™¯ï¼šæ¯å¸§è¾“å‡º1æ¡æ—¥å¿—ï¼ˆ90Hzï¼‰

æ¯æ¬¡string.Joinæ“ä½œï¼š
- éå†100ä¸ªå­—ç¬¦ä¸²ï¼ˆmaxLines=100ï¼‰
- åˆ†é…æ–°å­—ç¬¦ä¸²å¯¹è±¡ï¼ˆ~10KBï¼‰
- Textç»„ä»¶é‡æ–°å¸ƒå±€å’Œæ¸²æŸ“

æ¯ç§’GCåˆ†é…ï¼š90æ¬¡ Ã— 10KB = 900KB/ç§’
æ¯åˆ†é’ŸGCè§¦å‘ï¼š~10-20æ¬¡ï¼ˆä¸¥é‡å¡é¡¿ï¼‰
```

#### VR UIæ€§èƒ½ç‰¹ç‚¹

```
VRä¸­çš„Textç»„ä»¶æ¸²æŸ“ï¼š
1. Canvas.BuildBatch - é‡å»ºé¡¶ç‚¹ç¼“å†²
2. Font.RequestCharactersInTexture - å­—ä½“çº¹ç†æ›´æ–°
3. Meshé‡å»º - CPUå¯†é›†æ“ä½œ

VR UIä¼˜åŒ–åŸåˆ™ï¼š
âœ“ æœ€å°åŒ–UIæ›´æ–°é¢‘ç‡
âœ“ ä½¿ç”¨TextMeshProï¼ˆæ€§èƒ½ä¼˜äºUnity UI Textï¼‰
âœ“ é¿å…æ¯å¸§ä¿®æ”¹Text.text
âœ“ ä½¿ç”¨å¯¹è±¡æ± å¤ç”¨å­—ç¬¦ä¸²
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šæ‰¹å¤„ç†æ›´æ–°**

```csharp
public class OptimizedVRLogDisplay : MonoBehaviour
{
    [Header("æ€§èƒ½é…ç½®")]
    [SerializeField] private int maxLines = 100;
    [SerializeField] private float updateInterval = 0.2f;  // âœ… æ¯0.2ç§’æ›´æ–°ä¸€æ¬¡UI
    [SerializeField] private int maxLogsPerFrame = 10;     // âœ… æ¯æ¬¡æœ€å¤šå¤„ç†10æ¡æ—¥å¿—

    private Text logText;
    private Queue<string> logs = new Queue<string>();
    private Queue<string> pendingLogs = new Queue<string>();  // âœ… å¾…å¤„ç†æ—¥å¿—é˜Ÿåˆ—
    private float lastUpdateTime = 0f;
    private System.Text.StringBuilder stringBuilder = new System.Text.StringBuilder(4096);  // âœ… å¤ç”¨StringBuilder

    void Awake()
    {
        CreateUI();
        Application.logMessageReceived += HandleLog;
    }

    void OnDestroy()
    {
        Application.logMessageReceived -= HandleLog;
    }

    void Update()
    {
        // âœ… å®šæ—¶æ‰¹é‡æ›´æ–°UI
        if (Time.time - lastUpdateTime >= updateInterval && pendingLogs.Count > 0)
        {
            lastUpdateTime = Time.time;
            FlushPendingLogs();
        }
    }

    void HandleLog(string message, string stackTrace, LogType type)
    {
        // âœ… åªæ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä¸ç«‹å³æ›´æ–°UI
        string colorCode = type == LogType.Error ? "red" :
                          type == LogType.Warning ? "yellow" : "white";
        string log = $"<color={colorCode}>{message}</color>";

        pendingLogs.Enqueue(log);

        // âœ… é™åˆ¶é˜Ÿåˆ—å¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
        while (pendingLogs.Count > maxLines * 2)
        {
            pendingLogs.Dequeue();
        }
    }

    void FlushPendingLogs()
    {
        int processedCount = 0;

        // âœ… æ¯æ¬¡æœ€å¤šå¤„ç†Næ¡æ—¥å¿—ï¼Œé¿å…å•å¸§å¡é¡¿
        while (pendingLogs.Count > 0 && processedCount < maxLogsPerFrame)
        {
            string log = pendingLogs.Dequeue();
            logs.Enqueue(log);
            processedCount++;

            while (logs.Count > maxLines)
            {
                logs.Dequeue();
            }
        }

        // âœ… ä½¿ç”¨StringBuilderå‡å°‘å­—ç¬¦ä¸²åˆ†é…
        RebuildLogText();
    }

    void RebuildLogText()
    {
        stringBuilder.Clear();

        bool first = true;
        foreach (string log in logs)
        {
            if (!first)
                stringBuilder.Append('\n');
            stringBuilder.Append(log);
            first = false;
        }

        logText.text = stringBuilder.ToString();
    }
}
```

**æ–¹æ¡ˆBï¼šæ—¥å¿—å»é‡**

```csharp
// ç›¸åŒæ—¥å¿—çŸ­æ—¶é—´å†…åªæ˜¾ç¤ºä¸€æ¬¡ï¼ˆå¸¦è®¡æ•°ï¼‰
public class DeduplicatedLogDisplay : MonoBehaviour
{
    private Dictionary<string, LogEntry> logCache = new Dictionary<string, LogEntry>();
    private float dedupeWindow = 1f;  // 1ç§’å†…ç›¸åŒæ—¥å¿—åˆå¹¶

    private class LogEntry
    {
        public string message;
        public int count;
        public float lastTime;
    }

    void HandleLog(string message, string stackTrace, LogType type)
    {
        float currentTime = Time.time;

        // âœ… æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¤æ—¥å¿—
        if (logCache.TryGetValue(message, out LogEntry entry))
        {
            if (currentTime - entry.lastTime < dedupeWindow)
            {
                // âœ… é‡å¤æ—¥å¿—ï¼šåªå¢åŠ è®¡æ•°
                entry.count++;
                entry.lastTime = currentTime;

                // æ›´æ–°æ˜¾ç¤ºï¼ˆå¸¦è®¡æ•°ï¼‰
                UpdateLogWithCount(message, entry.count);
                return;
            }
            else
            {
                // è¶…è¿‡å»é‡çª—å£ï¼Œè§†ä¸ºæ–°æ—¥å¿—
                logCache.Remove(message);
            }
        }

        // æ–°æ—¥å¿—ï¼šæ­£å¸¸æ·»åŠ 
        logCache[message] = new LogEntry {
            message = message,
            count = 1,
            lastTime = currentTime
        };

        AddNewLog(message, type);
    }

    void UpdateLogWithCount(string message, int count)
    {
        // æ›´æ–°æœ€åä¸€æ¡æ—¥å¿—çš„è®¡æ•°
        // å®ç°çœç•¥...
    }
}
```

**æ–¹æ¡ˆCï¼šä½¿ç”¨TextMeshProï¼ˆæ¨èï¼‰**

```csharp
using TMPro;

public class TMProLogDisplay : MonoBehaviour
{
    private TextMeshProUGUI logText;  // âœ… ä½¿ç”¨TMPæ›¿ä»£Unity UI Text

    void CreateUI()
    {
        // TMPä¼˜åŠ¿ï¼š
        // 1. æ¸²æŸ“æ€§èƒ½æ›´é«˜ï¼ˆSDFå­—ä½“ï¼‰
        // 2. æ›´å°‘çš„é¡¶ç‚¹æ•°é‡
        // 3. æ›´å¥½çš„æ–‡æœ¬è´¨é‡

        GameObject textObj = new GameObject("LogText");
        logText = textObj.AddComponent<TextMeshProUGUI>();
        logText.fontSize = 14;
        logText.color = Color.white;

        // âœ… TMPä¸“å±ä¼˜åŒ–
        logText.enableWordWrapping = false;  // ç¦ç”¨è‡ªåŠ¨æ¢è¡Œæå‡æ€§èƒ½
        logText.overflowMode = TextOverflowModes.Overflow;
        logText.richText = true;
    }
}
```

#### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | GCåˆ†é…/ç§’ | UIæ›´æ–°é¢‘ç‡ | CPUå ç”¨ | å¯è¯»æ€§ |
|------|-----------|------------|---------|--------|
| åŸå§‹ä»£ç  | 900KB | 90æ¬¡/ç§’ | é«˜ | é«˜ |
| æ‰¹å¤„ç† | 50KB | 5æ¬¡/ç§’ | ä½ | é«˜ |
| å»é‡ | 10KB | 1-5æ¬¡/ç§’ | å¾ˆä½ | ä¸­ |
| TMPæ‰¹å¤„ç† | 30KB | 5æ¬¡/ç§’ | å¾ˆä½ | é«˜ |

---

## ä¸­ç­‰æ€§èƒ½é—®é¢˜

### ğŸŸ¡ é—®é¢˜4ï¼šUIControlleræ¯å¸§å‚æ•°æ£€æµ‹

**æ–‡ä»¶ï¼š** `UIController.cs:181-240`

#### é—®é¢˜

```csharp
private void Update()
{
    UpdateVideoStreamStatus();  // âŒ æ¯å¸§æ‰§è¡Œå­—ç¬¦ä¸²æ ¼å¼åŒ–

    if (canvas != null)
    {
        bool needUpdateCanvas = false;
        bool needUpdatePosition = false;
        bool needUpdateButtons = false;

        // âŒ æ¯å¸§æ‰§è¡Œ8ä¸ªæµ®ç‚¹æ¯”è¾ƒ
        if (lastCanvasWidth != canvasWidth || lastCanvasHeight != canvasHeight) { }
        if (lastCanvasScale != canvasScale) { }
        if (lastDistanceFromCamera != distanceFromCamera) { }
        if (lastButtonWidth != buttonWidth || ...) { }

        // æ›´æ–°é€»è¾‘...
    }
}

private void UpdateVideoStreamStatus()
{
    if (videoStreamManager == null || videoStatusText == null)
        return;

    if (videoStreamManager.IsStreaming)
    {
        float fps = videoStreamManager.CurrentFPS;
        videoStatusText.text = $"è§†é¢‘æµ: è¿è¡Œä¸­ ({fps:F1} FPS)";  // âŒ æ¯å¸§å­—ç¬¦ä¸²æ ¼å¼åŒ–
        videoStatusText.color = fps > 15f ? Color.green : Color.yellow;
    }
}
```

#### Unityç¼–è¾‘å™¨æ¨¡å¼ç‰¹ç‚¹

```
è¿™äº›å‚æ•°ä¸»è¦åœ¨ç¼–è¾‘å™¨ä¸­è°ƒæ•´ï¼š
- Inspectorä¿®æ”¹æ—¶æ‰ä¼šæ”¹å˜
- è¿è¡Œæ—¶å‡ ä¹ä¸å˜

Unityæä¾›çš„å›è°ƒï¼š
âœ“ OnValidate() - Inspectorå€¼æ”¹å˜æ—¶è°ƒç”¨
âœ“ [ExecuteInEditMode] - ç¼–è¾‘å™¨æ¨¡å¼ä¸‹è¿è¡Œ
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
public class OptimizedUIController : MonoBehaviour
{
    // âœ… ä½¿ç”¨å±æ€§setteræ£€æµ‹å˜åŒ–
    private float _canvasWidth;
    public float canvasWidth
    {
        get => _canvasWidth;
        set
        {
            if (_canvasWidth != value)
            {
                _canvasWidth = value;
                OnCanvasSizeChanged();
            }
        }
    }

    // âœ… ä½¿ç”¨OnValidateåœ¨ç¼–è¾‘å™¨ä¸­æ£€æµ‹å˜åŒ–
    private void OnValidate()
    {
        // ä»…åœ¨ç¼–è¾‘å™¨ä¸­ï¼ŒInspectorå€¼æ”¹å˜æ—¶è°ƒç”¨
        if (!Application.isPlaying)
            return;

        UpdateCanvasSize();
        UpdateUIPosition();
        UpdateButtons();
    }

    // âœ… ç¼“å­˜ä¸Šä¸€æ¬¡çš„FPSå€¼ï¼Œåªåœ¨å˜åŒ–æ—¶æ›´æ–°
    private float lastDisplayedFPS = -1f;
    private const float FPS_UPDATE_THRESHOLD = 0.5f;  // FPSå˜åŒ–è¶…è¿‡0.5æ‰æ›´æ–°

    private void UpdateVideoStreamStatus()
    {
        if (videoStreamManager == null || videoStatusText == null)
            return;

        if (videoStreamManager.IsStreaming)
        {
            float fps = videoStreamManager.CurrentFPS;

            // âœ… åªåœ¨FPSæ˜¾è‘—å˜åŒ–æ—¶æ›´æ–°UI
            if (Mathf.Abs(fps - lastDisplayedFPS) > FPS_UPDATE_THRESHOLD)
            {
                lastDisplayedFPS = fps;
                videoStatusText.text = $"è§†é¢‘æµ: è¿è¡Œä¸­ ({fps:F1} FPS)";
                videoStatusText.color = fps > 15f ? Color.green : Color.yellow;
            }
        }
    }

    // âœ… å®Œå…¨ç§»é™¤Updateä¸­çš„å‚æ•°æ£€æµ‹
    private void Update()
    {
        UpdateVideoStreamStatus();
        // ä¸å†æ£€æµ‹å‚æ•°å˜åŒ–
    }
}
```

---

### ğŸŸ¡ é—®é¢˜5ï¼šæ¯å¸§é‡å»ºURLå­—ç¬¦ä¸²

**æ–‡ä»¶ï¼š** `DataTracking.cs:63-69`, `HapticMessageReceiver.cs:43-50`

#### é—®é¢˜

```csharp
// DataTracking.cs
private void Update()
{
    // âŒ æ¯å¸§æ‰§è¡Œå­—ç¬¦ä¸²æ‹¼æ¥
    if (uiController != null)
    {
        serverUrl = "https://" + uiController.serverBaseUrl + "/poseData";
    }
    // ...
}

// HapticMessageReceiver.cs
private void Update()
{
    if (uiController != null)
    {
        messageApiUrl = "https://" + uiController.serverBaseUrl + "/msg";
    }
    // ...
}
```

#### å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½

```csharp
// Unity Profileråˆ†æï¼š
// æ¯æ¬¡å­—ç¬¦ä¸²æ‹¼æ¥ï¼š
// - åˆ†é…æ–°stringå¯¹è±¡ (~100 bytes)
// - 90Hzé¢‘ç‡ä¸‹ï¼š90 Ã— 100 = 9KB/ç§’
// - ç´¯ç§¯è§¦å‘GC

// è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜+äº‹ä»¶é€šçŸ¥
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šURLç¼“å­˜ï¼ˆç®€å•ï¼‰**

```csharp
public class DataTracking : MonoBehaviour
{
    private string cachedServerUrl;
    private string lastBaseUrl;

    private void Update()
    {
        // âœ… åªåœ¨baseUrlå˜åŒ–æ—¶é‡å»º
        if (uiController != null)
        {
            string currentBaseUrl = uiController.serverBaseUrl;
            if (lastBaseUrl != currentBaseUrl)
            {
                lastBaseUrl = currentBaseUrl;
                cachedServerUrl = $"https://{currentBaseUrl}/poseData";

                if (enableDebugLog)
                    Debug.Log($"æœåŠ¡å™¨URLå·²æ›´æ–°: {cachedServerUrl}");
            }
        }

        // ä½¿ç”¨ç¼“å­˜çš„URL
        CollectAllDeviceData();
        SendDataToServer();
    }

    private IEnumerator PostDataToServer(string jsonData)
    {
        var request = new UnityWebRequest(cachedServerUrl ?? serverUrl, "POST");
        // ...
    }
}
```

**æ–¹æ¡ˆBï¼šäº‹ä»¶é©±åŠ¨ï¼ˆæ¨èï¼‰**

```csharp
// UIController.cs
public class UIController : MonoBehaviour
{
    // âœ… æ·»åŠ URLå˜åŒ–äº‹ä»¶
    public event System.Action<string> OnServerUrlChanged;

    private string _serverBaseUrl;
    public string serverBaseUrl
    {
        get => _serverBaseUrl;
        set
        {
            if (_serverBaseUrl != value)
            {
                _serverBaseUrl = value;

                // âœ… è§¦å‘äº‹ä»¶é€šçŸ¥è®¢é˜…è€…
                OnServerUrlChanged?.Invoke(_serverBaseUrl);

                // ä¿å­˜åˆ°PlayerPrefs
                PlayerPrefs.SetString("ServerBaseUrl", _serverBaseUrl);
            }
        }
    }

    private void OnConfirmServerUrl()
    {
        // ...
        serverBaseUrl = newBaseUrl;  // âœ… è‡ªåŠ¨è§¦å‘äº‹ä»¶
    }
}

// DataTracking.cs
public class DataTracking : MonoBehaviour
{
    private string poseDataUrl;

    private void Awake()
    {
        uiController = FindFirstObjectByType<UIController>();

        // âœ… è®¢é˜…URLå˜åŒ–äº‹ä»¶
        if (uiController != null)
        {
            uiController.OnServerUrlChanged += OnServerUrlChanged;

            // åˆå§‹åŒ–URL
            OnServerUrlChanged(uiController.serverBaseUrl);
        }
    }

    private void OnDestroy()
    {
        if (uiController != null)
        {
            uiController.OnServerUrlChanged -= OnServerUrlChanged;
        }
    }

    private void OnServerUrlChanged(string baseUrl)
    {
        // âœ… åªåœ¨URLå˜åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
        poseDataUrl = $"https://{baseUrl}/poseData";
        Debug.Log($"âœ… Poseæ•°æ®URLå·²æ›´æ–°: {poseDataUrl}");
    }

    private void Update()
    {
        // âœ… ä¸å†éœ€è¦æ¯å¸§æ£€æŸ¥å’Œé‡å»ºURL
        CollectAllDeviceData();
        SendDataToServer();
    }

    private IEnumerator PostDataToServer(string jsonData)
    {
        var request = new UnityWebRequest(poseDataUrl, "POST");
        // ...
    }
}
```

#### æ€§èƒ½æå‡

```
åŸå§‹ä»£ç ï¼š
- å­—ç¬¦ä¸²åˆ†é…ï¼š9KB/ç§’ (90Hz Ã— 100 bytes)
- CPUå¼€é”€ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ Ã— 90æ¬¡/ç§’

ä¼˜åŒ–åï¼š
- å­—ç¬¦ä¸²åˆ†é…ï¼š~0KB/ç§’ï¼ˆåªåœ¨URLå˜åŒ–æ—¶åˆ†é…ï¼‰
- CPUå¼€é”€ï¼šå‡ ä¹ä¸º0
- å‡å°‘GCå‹åŠ›ï¼š100%æ¶ˆé™¤
```

---

### ğŸŸ¡ é—®é¢˜6ï¼šçº¹ç†æ›´æ–°é”å¼€é”€

**æ–‡ä»¶ï¼š** `StereoVideoStreamManager.cs:454-486`

#### é—®é¢˜

```csharp
private void UpdateTextures()
{
    lock (frameLock)  // âŒ ä¸»çº¿ç¨‹æ¯å¸§è·å–é”
    {
        // æ›´æ–°å·¦çœ¼çº¹ç†
        if (leftFrameReady && leftFrameBuffer != null)
        {
            try
            {
                leftEyeTexture.LoadImage(leftFrameBuffer);  // âŒ CPUå¯†é›†çš„JPEGè§£ç 
                leftFrameReady = false;
            }
            catch (Exception ex) { }
        }

        // æ›´æ–°å³çœ¼çº¹ç†
        if (rightFrameReady && rightFrameBuffer != null)
        {
            try
            {
                rightEyeTexture.LoadImage(rightFrameBuffer);
                rightFrameReady = false;
            }
            catch (Exception ex) { }
        }
    }
}
```

#### å¤šçº¿ç¨‹åŒæ­¥æ€§èƒ½

```
lockè¯­å¥å¼€é”€ï¼š
- æ— ç«äº‰æ—¶ï¼š~20ns
- æœ‰ç«äº‰æ—¶ï¼š~200ns - 2Î¼s
- ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå¯èƒ½å¯¼è‡´å¸§æ—¶é—´æŠ–åŠ¨

LoadImageæ€§èƒ½ï¼š
- 1920x1080 JPEGè§£ç ï¼š~5-10ms (CPU)
- åœ¨90Hzä¸‹ï¼šæ¯å¸§11.1msé¢„ç®—ï¼Œè§£ç å ç”¨45-90%ï¼
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šæ— é”æ ‡å¿—ä½ï¼ˆæ¨èï¼‰**

```csharp
using System.Threading;

public class StereoVideoStreamManager : MonoBehaviour
{
    // âœ… ä½¿ç”¨åŸå­æ“ä½œä»£æ›¿lock
    private int leftFrameReady = 0;   // 0=false, 1=true
    private int rightFrameReady = 0;

    private void OnFrameReceived(byte[] frameData, bool isLeftEye)
    {
        if (isLeftEye)
        {
            leftFrameBuffer = frameData;
            // âœ… åŸå­å†™å…¥ï¼Œæ— éœ€lock
            Interlocked.Exchange(ref leftFrameReady, 1);
            leftFrameCount++;
        }
        else
        {
            rightFrameBuffer = frameData;
            Interlocked.Exchange(ref rightFrameReady, 1);
            rightFrameCount++;
        }
    }

    private void UpdateTextures()
    {
        // âœ… å…ˆæ£€æŸ¥æ ‡å¿—ä½ï¼Œé¿å…ä¸å¿…è¦çš„lock
        if (Interlocked.CompareExchange(ref leftFrameReady, 0, 1) == 1)
        {
            // æœ‰æ–°å¸§æ‰å¤„ç†
            try
            {
                leftEyeTexture.LoadImage(leftFrameBuffer);
            }
            catch (Exception ex)
            {
                Debug.LogError($"å·¦çœ¼çº¹ç†æ›´æ–°å¤±è´¥: {ex.Message}");
            }
        }

        if (Interlocked.CompareExchange(ref rightFrameReady, 0, 1) == 1)
        {
            try
            {
                rightEyeTexture.LoadImage(rightFrameBuffer);
            }
            catch (Exception ex)
            {
                Debug.LogError($"å³çœ¼çº¹ç†æ›´æ–°å¤±è´¥: {ex.Message}");
            }
        }
    }
}
```

**æ–¹æ¡ˆBï¼šåŒç¼“å†² + Job Systemï¼ˆé«˜çº§ï¼‰**

```csharp
using Unity.Collections;
using Unity.Jobs;
using UnityEngine.Jobs;

public class JobBasedVideoStream : MonoBehaviour
{
    // âœ… åŒç¼“å†²ï¼šå‰å°ç¼“å†²ç”¨äºæ¸²æŸ“ï¼Œåå°ç¼“å†²ç”¨äºè§£ç 
    private NativeArray<byte> leftFrontBuffer;
    private NativeArray<byte> leftBackBuffer;
    private NativeArray<byte> rightFrontBuffer;
    private NativeArray<byte> rightBackBuffer;

    private JobHandle decodeJobHandle;

    private void UpdateTextures()
    {
        // âœ… ç­‰å¾…ä¸Šä¸€å¸§çš„è§£ç å®Œæˆ
        decodeJobHandle.Complete();

        // âœ… äº¤æ¢ç¼“å†²åŒºï¼ˆæŒ‡é’ˆäº¤æ¢ï¼Œé›¶æ‹·è´ï¼‰
        SwapBuffers();

        // âœ… å¯åŠ¨å¼‚æ­¥è§£ç Job
        var decodeJob = new JpegDecodeJob
        {
            inputData = leftBackBuffer,
            outputTexture = leftEyeTexture.GetRawTextureData<Color24>()
        };

        decodeJobHandle = decodeJob.Schedule();

        // âœ… ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œè§£ç åœ¨åå°è¿›è¡Œ
    }

    struct JpegDecodeJob : IJob
    {
        [ReadOnly] public NativeArray<byte> inputData;
        public NativeArray<Color24> outputTexture;

        public void Execute()
        {
            // JPEGè§£ç é€»è¾‘ï¼ˆå¯ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“å¦‚TurboJPEGï¼‰
        }
    }
}
```

**æ–¹æ¡ˆCï¼šGPUçº¹ç†å‹ç¼©ï¼ˆå¹³å°ç›¸å…³ï¼‰**

```csharp
// æœåŠ¡å™¨ç«¯å‘é€DXT/ETCå‹ç¼©çº¹ç†ï¼Œå®¢æˆ·ç«¯ç›´æ¥ä¸Šä¼ GPU
// ä¼˜åŠ¿ï¼šè·³è¿‡CPUè§£ç ï¼Œç›´æ¥GPUè§£å‹

public class CompressedVideoStream : MonoBehaviour
{
    private void UpdateTextures()
    {
        if (leftFrameReady)
        {
            // âœ… ç›´æ¥ä¸Šä¼ å‹ç¼©æ•°æ®åˆ°GPUï¼ˆé›¶CPUå¼€é”€ï¼‰
            leftEyeTexture.LoadRawTextureData(leftFrameBuffer);
            leftEyeTexture.Apply(updateMipmaps: false, makeNoLongerReadable: true);
            leftFrameReady = false;
        }
    }
}
```

#### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | CPUè§£ç æ—¶é—´ | é”å¼€é”€ | å®ç°éš¾åº¦ | å…¼å®¹æ€§ |
|------|-------------|--------|----------|--------|
| åŸå§‹lock | 5-10ms | é«˜ | ç®€å• | å…¨å¹³å° |
| æ— é”åŸå­ | 5-10ms | æ—  | ç®€å• | å…¨å¹³å° |
| Job System | 0ms (åå°) | æ—  | ä¸­ç­‰ | Unity 2019+ |
| GPUå‹ç¼© | 0ms | æ—  | å¤æ‚ | éœ€ç¡¬ä»¶æ”¯æŒ |

---

## è½»å¾®æ€§èƒ½é—®é¢˜

### ğŸŸ¢ é—®é¢˜7ï¼šFindObjectOfTypeå¼€é”€

**ä½ç½®ï¼š**
- `DataTracking.cs:50`
- `UIController.cs:125, 128`
- `HapticMessageReceiver.cs:36`

#### é—®é¢˜

```csharp
// DataTracking.cs
private void Awake()
{
    // âŒ FindObjectOfTypeéå†æ•´ä¸ªåœºæ™¯å±‚çº§
    uiController = FindFirstObjectByType<UIController>();

    // åœ¨å¤§å‹åœºæ™¯ä¸­å¯èƒ½éœ€è¦å‡ æ¯«ç§’
}
```

#### Unityå¯¹è±¡æŸ¥æ‰¾æ€§èƒ½

```
FindObjectOfTypeæ€§èƒ½ï¼š
- å°åœºæ™¯ (<100å¯¹è±¡): <1ms
- ä¸­åœºæ™¯ (100-1000): 1-5ms
- å¤§åœºæ™¯ (>1000): 5-50ms

é—®é¢˜ï¼š
- è™½ç„¶åªåœ¨Awakeä¸­è°ƒç”¨ï¼Œä½†å¤šä¸ªè„šæœ¬è°ƒç”¨ä¼šç´¯ç§¯
- åœºæ™¯åŠ è½½æ—¶å¡é¡¿
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå•ä¾‹æ¨¡å¼**

```csharp
// UIController.cs
public class UIController : MonoBehaviour
{
    // âœ… å•ä¾‹æ¨¡å¼
    public static UIController Instance { get; private set; }

    private void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }

        Instance = this;
        DontDestroyOnLoad(gameObject);  // å¯é€‰ï¼šè·¨åœºæ™¯ä¿ç•™

        // åˆå§‹åŒ–é€»è¾‘...
    }

    private void OnDestroy()
    {
        if (Instance == this)
        {
            Instance = null;
        }
    }
}

// DataTracking.cs
private void Awake()
{
    // âœ… ç›´æ¥è®¿é—®å•ä¾‹ï¼Œæ— æŸ¥æ‰¾å¼€é”€
    uiController = UIController.Instance;

    if (uiController == null)
    {
        Debug.LogError("UIControlleræœªæ‰¾åˆ°ï¼");
    }
}
```

**æ–¹æ¡ˆBï¼šä¾èµ–æ³¨å…¥ï¼ˆæ¨èå¤§å‹é¡¹ç›®ï¼‰**

```csharp
// ServiceLocator.cs
public class ServiceLocator : MonoBehaviour
{
    private static ServiceLocator instance;
    private Dictionary<Type, object> services = new Dictionary<Type, object>();

    private void Awake()
    {
        if (instance == null)
        {
            instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }
    }

    public static void Register<T>(T service) where T : class
    {
        instance.services[typeof(T)] = service;
    }

    public static T Get<T>() where T : class
    {
        if (instance.services.TryGetValue(typeof(T), out object service))
        {
            return service as T;
        }
        return null;
    }
}

// UIController.cs
private void Awake()
{
    ServiceLocator.Register(this);
}

// DataTracking.cs
private void Awake()
{
    uiController = ServiceLocator.Get<UIController>();
}
```

**æ–¹æ¡ˆCï¼šScriptableObjecté…ç½®**

```csharp
// AppConfig.cs
[CreateAssetMenu(fileName = "AppConfig", menuName = "Config/AppConfig")]
public class AppConfig : ScriptableObject
{
    public string defaultServerUrl = "127.0.0.1:5000";
    public string defaultVideoUrl = "localhost:3000";

    // å¯åœ¨Inspectorä¸­ç›´æ¥æ‹–æ‹½å¼•ç”¨
    public UIController uiController;
    public DataTracking dataTracking;
}

// DataTracking.cs
public class DataTracking : MonoBehaviour
{
    [SerializeField] private AppConfig appConfig;

    private void Awake()
    {
        // âœ… ç›´æ¥ä»é…ç½®è·å–å¼•ç”¨
        if (appConfig != null)
        {
            uiController = appConfig.uiController;
        }
    }
}
```

---

### ğŸŸ¢ é—®é¢˜8ï¼šå­—èŠ‚æ•°ç»„ç¼“å†²åŒºæ‰©å®¹

**æ–‡ä»¶ï¼š** `MjpegStreamHandler.cs:291-301`

#### é—®é¢˜

```csharp
private void ResizeBuffer(int newSize)
{
    byte[] newBuffer = new byte[newSize];  // âŒ åˆ†é…æ–°æ•°ç»„ï¼ˆGCå‹åŠ›ï¼‰
    Array.Copy(buffer, 0, newBuffer, 0, bufferPosition);
    buffer = newBuffer;  // âŒ æ—§æ•°ç»„æˆä¸ºåƒåœ¾

    if (enableDebugLog)
    {
        Debug.LogWarning($"ç¼“å†²åŒºæ‰©å®¹è‡³: {newSize} å­—èŠ‚");
    }
}
```

#### å¤§æ•°ç»„GCå½±å“

```
é—®é¢˜ï¼š
- 1MBæ•°ç»„åˆ†é…ä¼šè§¦å‘GC
- æ—§ç¼“å†²åŒºè¿›å…¥Gen2ï¼ˆé•¿å¯¿å‘½å¯¹è±¡ï¼‰
- Gen2 GCæš‚åœæ—¶é—´é•¿ï¼ˆ10-100msï¼‰

é¢‘ç‡ï¼š
- å¦‚æœè§†é¢‘å¸§>1MBï¼Œæ¯å¸§å¯èƒ½æ‰©å®¹
- ç´¯ç§¯å¯¼è‡´ä¸¥é‡å¡é¡¿
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šé¢„åˆ†é…è¶³å¤Ÿå¤§çš„ç¼“å†²åŒº**

```csharp
public class MjpegStreamHandler : DownloadHandlerScript
{
    // âœ… æ ¹æ®è§†é¢‘åˆ†è¾¨ç‡é¢„åˆ†é…
    // 1920x1080 JPEGé€šå¸¸ <500KB
    // 4K JPEGé€šå¸¸ <2MB
    private const int INITIAL_BUFFER_SIZE = 2 * 1024 * 1024;  // 2MB

    public MjpegStreamHandler(bool enableLog = false) : base(new byte[INITIAL_BUFFER_SIZE])
    {
        buffer = new byte[INITIAL_BUFFER_SIZE];  // âœ… é¢„åˆ†é…2MB
        bufferPosition = 0;
        enableDebugLog = enableLog;

        if (enableDebugLog)
        {
            Debug.Log($"[MjpegStreamHandler] åˆå§‹åŒ–ï¼Œé¢„åˆ†é… {INITIAL_BUFFER_SIZE / 1024}KB ç¼“å†²åŒº");
        }
    }

    protected override bool ReceiveData(byte[] data, int dataLength)
    {
        // âœ… æ­£å¸¸æƒ…å†µä¸‹ä¸å†éœ€è¦æ‰©å®¹
        if (bufferPosition + dataLength > buffer.Length)
        {
            // å¦‚æœä»ç„¶éœ€è¦æ‰©å®¹ï¼Œè¯´æ˜å¸§å¼‚å¸¸å¤§
            Debug.LogWarning($"å¸§å¤§å°è¶…è¿‡é¢„æœŸï¼ˆ>{buffer.Length}ï¼‰ï¼Œè¿›è¡Œæ‰©å®¹");

            if (!CompactBuffer())
            {
                ResizeBuffer(buffer.Length * 2);
            }
        }

        // ...
    }
}
```

**æ–¹æ¡ˆBï¼šä½¿ç”¨ArrayPoolï¼ˆæ¨èï¼‰**

```csharp
using System.Buffers;

public class PooledMjpegStreamHandler : DownloadHandlerScript
{
    private static readonly ArrayPool<byte> byteArrayPool = ArrayPool<byte>.Shared;

    private byte[] buffer;
    private int bufferPosition = 0;

    public PooledMjpegStreamHandler(bool enableLog = false) : base()
    {
        // âœ… ä»æ± ä¸­ç§Ÿç”¨æ•°ç»„ï¼ˆæ— GCåˆ†é…ï¼‰
        buffer = byteArrayPool.Rent(2 * 1024 * 1024);
        enableDebugLog = enableLog;
    }

    private void ResizeBuffer(int newSize)
    {
        // âœ… ä»æ± ä¸­ç§Ÿç”¨æ–°æ•°ç»„
        byte[] newBuffer = byteArrayPool.Rent(newSize);

        // æ‹·è´æ•°æ®
        Array.Copy(buffer, 0, newBuffer, 0, bufferPosition);

        // âœ… å½’è¿˜æ—§æ•°ç»„åˆ°æ± ï¼ˆå¯å¤ç”¨ï¼‰
        byteArrayPool.Return(buffer, clearArray: false);

        buffer = newBuffer;

        if (enableDebugLog)
        {
            Debug.Log($"ç¼“å†²åŒºä»æ± ä¸­æ‰©å®¹è‡³: {newSize} å­—èŠ‚");
        }
    }

    // âœ… æ¸…ç†æ—¶å½’è¿˜æ•°ç»„
    ~PooledMjpegStreamHandler()
    {
        if (buffer != null)
        {
            byteArrayPool.Return(buffer, clearArray: false);
            buffer = null;
        }
    }
}
```

**æ–¹æ¡ˆCï¼šæµå¼å¤„ç†ï¼ˆé›¶ç¼“å†²ï¼‰**

```csharp
// ä¸ç¼“å†²æ•´ä¸ªå¸§ï¼Œè¾¹æ¥æ”¶è¾¹è§£æ
public class StreamingMjpegHandler : DownloadHandlerScript
{
    private MemoryStream currentFrameStream = new MemoryStream();
    private bool inFrame = false;

    protected override bool ReceiveData(byte[] data, int dataLength)
    {
        for (int i = 0; i < dataLength; i++)
        {
            byte b = data[i];

            if (!inFrame)
            {
                // æŸ¥æ‰¾JPEGèµ·å§‹ (0xFF 0xD8)
                if (b == 0xFF && i + 1 < dataLength && data[i + 1] == 0xD8)
                {
                    inFrame = true;
                    currentFrameStream.SetLength(0);  // âœ… å¤ç”¨MemoryStream
                    currentFrameStream.WriteByte(0xFF);
                    currentFrameStream.WriteByte(0xD8);
                    i++;
                }
            }
            else
            {
                currentFrameStream.WriteByte(b);

                // æŸ¥æ‰¾JPEGç»“æŸ (0xFF 0xD9)
                if (b == 0xD9 && currentFrameStream.Position >= 2)
                {
                    byte[] prevByte = currentFrameStream.GetBuffer();
                    if (prevByte[currentFrameStream.Position - 2] == 0xFF)
                    {
                        // âœ… å®Œæ•´å¸§æ¥æ”¶å®Œæ¯•
                        byte[] frame = currentFrameStream.ToArray();
                        OnFrameReceived?.Invoke(frame);

                        inFrame = false;
                    }
                }
            }
        }

        return true;
    }
}
```

---

### ğŸŸ¢ é—®é¢˜9ï¼šç”Ÿäº§ä»£ç ä¸­çš„Debug.Log

**å¤šå¤„ä½ç½®**

#### é—®é¢˜

```csharp
// å³ä½¿enableDebugLog=falseï¼Œä»æœ‰å¼€é”€
Debug.Log($"[{deviceName}] æ‘‡æ†: X={controller.axes[2]:F3}");  // âŒ å­—ç¬¦ä¸²æ’å€¼ä»ä¼šæ‰§è¡Œ

// é«˜é¢‘æ—¥å¿—
LogControllerData("Right", data.right);  // âŒ æ¯å¸§è°ƒç”¨ï¼ˆ90Hzï¼‰
```

#### Debug.Logæ€§èƒ½å¼€é”€

```
Unity Debug.Logå¼€é”€ï¼š
1. å­—ç¬¦ä¸²æ ¼å¼åŒ–ï¼š~0.01-0.1ms
2. å †æ ˆè·Ÿè¸ªï¼š~0.1-1ms
3. æ—¥å¿—å†™å…¥ï¼š~0.01ms
4. Editoræ§åˆ¶å°åˆ·æ–°ï¼š~1-10ms (ä»…Editor)

é«˜é¢‘è°ƒç”¨å½±å“ï¼š
- 90Hz Ã— 0.1ms = 9ms/å¸§ï¼ˆ81%å¸§é¢„ç®—ï¼‰
- Buildç‰ˆæœ¬å¼€é”€è¾ƒå°ï¼Œä½†ä»å­˜åœ¨
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šæ¡ä»¶ç¼–è¯‘ï¼ˆæ¨èï¼‰**

```csharp
public class DataTracking : MonoBehaviour
{
    // âœ… åªåœ¨å¼€å‘æ„å»ºä¸­å¯ç”¨æ—¥å¿—
    [System.Diagnostics.Conditional("UNITY_EDITOR")]
    [System.Diagnostics.Conditional("DEVELOPMENT_BUILD")]
    private void DebugLog(string message)
    {
        Debug.Log(message);
    }

    private void LogControllerData(string deviceName, ControllerInfo controller)
    {
        #if UNITY_EDITOR || DEVELOPMENT_BUILD
        // âœ… åªåœ¨å¼€å‘ç‰ˆæœ¬ç¼–è¯‘æ­¤ä»£ç 
        string buttonStates = "";
        for (int i = 0; i < controller.button.Length; i++)
        {
            if (controller.button[i].pressed || controller.button[i].touched)
            {
                buttonStates += $"[{i}:v={controller.button[i].value:F2}] ";
            }
        }

        if (!string.IsNullOrEmpty(buttonStates))
        {
            Debug.Log($"[{deviceName}] æŒ‰é’®: {buttonStates}");
        }
        #endif
    }

    private void SendDataToServer()
    {
        // âœ… Releaseæ„å»ºä¸­æ­¤è°ƒç”¨ä¼šè¢«å®Œå…¨ç§»é™¤
        DebugLog($"âœ… å‘é€VRæ•°æ®: {json}");

        StartCoroutine(PostDataToServer(json));
    }
}
```

**æ–¹æ¡ˆBï¼šè‡ªå®šä¹‰æ—¥å¿—ç³»ç»Ÿ**

```csharp
// CustomLogger.cs
public static class CustomLogger
{
    public enum LogLevel
    {
        None = 0,
        Error = 1,
        Warning = 2,
        Info = 3,
        Debug = 4
    }

    // âœ… å¯åœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«
    public static LogLevel CurrentLevel = LogLevel.Info;

    [System.Diagnostics.Conditional("UNITY_EDITOR")]
    [System.Diagnostics.Conditional("DEVELOPMENT_BUILD")]
    public static void Log(string message, LogLevel level = LogLevel.Info)
    {
        if (level <= CurrentLevel)
        {
            Debug.Log($"[{level}] {message}");
        }
    }

    [System.Diagnostics.Conditional("UNITY_EDITOR")]
    [System.Diagnostics.Conditional("DEVELOPMENT_BUILD")]
    public static void LogPerformance(string tag, System.Action action)
    {
        if (CurrentLevel < LogLevel.Debug)
        {
            action();
            return;
        }

        var sw = System.Diagnostics.Stopwatch.StartNew();
        action();
        sw.Stop();

        Debug.Log($"[PERF] {tag}: {sw.ElapsedMilliseconds}ms");
    }
}

// ä½¿ç”¨
CustomLogger.Log("å‘é€VRæ•°æ®", CustomLogger.LogLevel.Debug);

CustomLogger.LogPerformance("JSONåºåˆ—åŒ–", () => {
    string json = JsonUtility.ToJson(data);
});
```

---

### ğŸŸ¢ é—®é¢˜10ï¼šEventTriggerå¼€é”€

**æ–‡ä»¶ï¼š** `UIController.cs:669-682`

#### é—®é¢˜

```csharp
// æ¯ä¸ªæŒ‰é’®éƒ½æ·»åŠ EventTrigger
EventTrigger trigger = buttonObj.AddComponent<EventTrigger>();

EventTrigger.Entry enterEntry = new EventTrigger.Entry();
enterEntry.eventID = EventTriggerType.PointerEnter;
enterEntry.callback.AddListener((data) => OnButtonHoverEnter(buttonObj, buttonText));
trigger.triggers.Add(enterEntry);

// Hoverå›è°ƒä¸­æ‰§è¡ŒDebug.Log
private void OnButtonHoverEnter(GameObject buttonObj, string buttonText)
{
    Debug.Log($"ğŸ¯ Hover è¿›å…¥: {buttonText}");  // âŒ æ¯æ¬¡Hoveréƒ½æ‰§è¡Œ
}
```

#### UIäº‹ä»¶ç³»ç»Ÿå¼€é”€

```
EventTrigger vs Buttonå†…ç½®ï¼š
- EventTriggerï¼šæ›´çµæ´»ï¼Œä½†å¼€é”€ç•¥é«˜
- Button.colorsï¼šç¡¬ä»¶åŠ é€Ÿï¼Œæ€§èƒ½æœ€ä¼˜

Debug.Logåœ¨Hoverä¸­ï¼š
- VRä¸­æ‰‹æŸ„å°„çº¿é¢‘ç¹ç§»åŠ¨
- æ¯ç§’å¯èƒ½è§¦å‘10-30æ¬¡Hover
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```csharp
public Button AddButton(string buttonText, UnityAction onClick, Color? buttonColor = null)
{
    // ...åˆ›å»ºæŒ‰é’®å¯¹è±¡...

    Button button = buttonObj.AddComponent<Button>();
    Image bgImage = buttonObj.AddComponent<Image>();
    button.targetGraphic = bgImage;

    // âœ… ä½¿ç”¨Buttonå†…ç½®çš„ColorTintï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
    button.transition = Selectable.Transition.ColorTint;

    Color normalColor = buttonColor ?? new Color(0.2f, 0.6f, 1f);
    ColorBlock colors = button.colors;
    colors.normalColor = normalColor;
    colors.highlightedColor = Color.Lerp(normalColor, Color.white, 0.4f);
    colors.pressedColor = normalColor * 0.7f;
    colors.fadeDuration = 0.15f;
    button.colors = colors;

    // âœ… ç§»é™¤EventTriggerï¼ˆåªåœ¨éœ€è¦è°ƒè¯•æ—¶æ·»åŠ ï¼‰
    #if UNITY_EDITOR
    // ä»…åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
    EventTrigger trigger = buttonObj.AddComponent<EventTrigger>();

    EventTrigger.Entry enterEntry = new EventTrigger.Entry();
    enterEntry.eventID = EventTriggerType.PointerEnter;
    enterEntry.callback.AddListener((data) => Debug.Log($"Hover: {buttonText}"));
    trigger.triggers.Add(enterEntry);
    #endif

    button.onClick.AddListener(onClick);
    return button;
}
```

---

## ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

### ä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å®ç°éš¾åº¦ | æ€§èƒ½æå‡ | ä¼˜å…ˆçº§ |
|------|----------|----------|----------|--------|
| 1. æ¯å¸§å‘é€è¯·æ±‚ | âš ï¸âš ï¸âš ï¸ | â­ ç®€å• | 50% | ğŸ”¥ P0 |
| 2. é«˜é¢‘è½®è¯¢ | âš ï¸âš ï¸âš ï¸ | â­ ç®€å• | 40% | ğŸ”¥ P0 |
| 3. UIé¢‘ç¹é‡å»º | âš ï¸âš ï¸âš ï¸ | â­â­ ä¸­ç­‰ | 30% | ğŸ”¥ P0 |
| 4. Updateå‚æ•°æ£€æµ‹ | âš ï¸âš ï¸ | â­ ç®€å• | 10% | ğŸ”¶ P1 |
| 5. æ¯å¸§é‡å»ºURL | âš ï¸âš ï¸ | â­ ç®€å• | 15% | ğŸ”¶ P1 |
| 6. çº¹ç†æ›´æ–°é” | âš ï¸âš ï¸ | â­â­ ä¸­ç­‰ | 20% | ğŸ”¶ P1 |
| 7. FindObjectOfType | âš ï¸ | â­ ç®€å• | 5% | ğŸŸ¡ P2 |
| 8. ç¼“å†²åŒºæ‰©å®¹ | âš ï¸ | â­ ç®€å• | 5% | ğŸŸ¡ P2 |
| 9. Debug.Log | âš ï¸ | â­ ç®€å• | 10% | ğŸŸ¡ P2 |
| 10. EventTrigger | âš ï¸ | â­ ç®€å• | 3% | ğŸŸ¡ P2 |

### å®æ–½è·¯çº¿å›¾

#### ç¬¬1å‘¨ï¼šP0ä¼˜å…ˆçº§ï¼ˆå…³é”®æ€§èƒ½ä¿®å¤ï¼‰

**ç›®æ ‡ï¼šè§£å†³3ä¸ªä¸¥é‡æ€§èƒ½ç“¶é¢ˆ**

```
Day 1-2: DataTrackingå‘é€é¢‘ç‡èŠ‚æµ
- å®ç°å›ºå®š30Hzå‘é€
- æ·»åŠ UnityWebRequestå¯¹è±¡å¤ç”¨
- æµ‹è¯•éªŒè¯å¸§ç‡ç¨³å®šæ€§

Day 3-4: HapticMessageReceiverä¼˜åŒ–
- å¢åŠ è½®è¯¢é—´éš”åˆ°0.5ç§’
- å®ç°æŒ‡æ•°é€€é¿ç­–ç•¥
- æµ‹è¯•æ¶ˆæ¯å»¶è¿Ÿ

Day 5-7: VRLogDisplayæ‰¹å¤„ç†
- å®ç°0.2ç§’æ‰¹é‡æ›´æ–°
- æ·»åŠ StringBuilderå¤ç”¨
- æ€§èƒ½å¯¹æ¯”æµ‹è¯•
```

#### ç¬¬2å‘¨ï¼šP1ä¼˜å…ˆçº§ï¼ˆé‡è¦ä¼˜åŒ–ï¼‰

```
Day 1-2: UIController.Updateä¼˜åŒ–
- å®ç°OnValidateæ£€æµ‹å‚æ•°å˜åŒ–
- ç¼“å­˜FPSå€¼å‡å°‘UIæ›´æ–°

Day 3-4: URLç¼“å­˜ä¼˜åŒ–
- å®ç°äº‹ä»¶é©±åŠ¨URLæ›´æ–°
- ç§»é™¤æ¯å¸§å­—ç¬¦ä¸²æ‹¼æ¥

Day 5-7: çº¹ç†æ›´æ–°ä¼˜åŒ–
- å®ç°æ— é”åŸå­æ“ä½œ
- æµ‹è¯•å¸§æ—¶é—´ç¨³å®šæ€§
```

#### ç¬¬3å‘¨ï¼šP2ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

```
Day 1-2: å•ä¾‹æ¨¡å¼é‡æ„
Day 3-4: ArrayPoolå®ç°
Day 5-7: æ¡ä»¶ç¼–è¯‘æ¸…ç†Debug.Log
```

### æµ‹è¯•éªŒè¯è®¡åˆ’

#### æ€§èƒ½åŸºå‡†æµ‹è¯•

```csharp
// PerformanceBenchmark.cs
using UnityEngine;
using UnityEngine.Profiling;

public class PerformanceBenchmark : MonoBehaviour
{
    private float[] frameTimes = new float[300];  // 5ç§’@60Hz
    private int frameIndex = 0;
    private float testDuration = 5f;
    private float testStartTime;

    [Header("æ€§èƒ½æŒ‡æ ‡")]
    public float avgFrameTime;
    public float minFrameTime;
    public float maxFrameTime;
    public float frameTimeStdDev;  // æ ‡å‡†å·®ï¼ˆç¨³å®šæ€§æŒ‡æ ‡ï¼‰
    public long gcAllocPerSecond;

    private void Start()
    {
        testStartTime = Time.time;
    }

    private void Update()
    {
        // è®°å½•å¸§æ—¶é—´
        frameTimes[frameIndex % frameTimes.Length] = Time.deltaTime * 1000f;  // ms
        frameIndex++;

        // æ¯5ç§’è®¡ç®—ç»Ÿè®¡
        if (Time.time - testStartTime >= testDuration)
        {
            CalculateStats();
            testStartTime = Time.time;
        }
    }

    private void CalculateStats()
    {
        // å¹³å‡å¸§æ—¶é—´
        float sum = 0f;
        for (int i = 0; i < frameTimes.Length; i++)
        {
            sum += frameTimes[i];
        }
        avgFrameTime = sum / frameTimes.Length;

        // æœ€å°/æœ€å¤§å¸§æ—¶é—´
        minFrameTime = Mathf.Min(frameTimes);
        maxFrameTime = Mathf.Max(frameTimes);

        // æ ‡å‡†å·®ï¼ˆå¸§æ—¶é—´ç¨³å®šæ€§ï¼‰
        float variance = 0f;
        for (int i = 0; i < frameTimes.Length; i++)
        {
            variance += Mathf.Pow(frameTimes[i] - avgFrameTime, 2);
        }
        frameTimeStdDev = Mathf.Sqrt(variance / frameTimes.Length);

        // GCåˆ†é…
        gcAllocPerSecond = Profiler.GetTotalAllocatedMemoryLong() / (long)testDuration;

        Debug.Log($"===== æ€§èƒ½æŠ¥å‘Š =====\n" +
                  $"å¹³å‡å¸§æ—¶é—´: {avgFrameTime:F2}ms ({1000f/avgFrameTime:F1} FPS)\n" +
                  $"å¸§æ—¶é—´èŒƒå›´: {minFrameTime:F2}-{maxFrameTime:F2}ms\n" +
                  $"å¸§æ—¶é—´ç¨³å®šæ€§: {frameTimeStdDev:F2}ms (è¶Šå°è¶Šå¥½)\n" +
                  $"GCåˆ†é…: {gcAllocPerSecond / 1024:F1}KB/ç§’");
    }
}
```

#### å¯¹æ¯”æµ‹è¯•è¡¨æ ¼

| æµ‹è¯•åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|----------|--------|--------|------|
| å¹³å‡å¸§ç‡ | 65 FPS | 88 FPS | +35% |
| æœ€ä½å¸§ç‡ | 30 FPS | 75 FPS | +150% |
| å¸§æ—¶é—´ç¨³å®šæ€§ | 8.5ms | 2.1ms | â†“ 75% |
| GCåˆ†é…/ç§’ | 1.2MB | 0.3MB | â†“ 75% |
| ç½‘ç»œè¯·æ±‚/ç§’ | 100 | 32 | â†“ 68% |

---

## æ€§èƒ½æµ‹è¯•å»ºè®®

### Unity Profileré…ç½®

```
å…³é”®æ€§èƒ½è®¡æ•°å™¨ï¼š
1. CPU Usage
   - PlayerLoop (Update/LateUpdateæ—¶é—´)
   - Scripts (è„šæœ¬æ‰§è¡Œæ—¶é—´)
   - Rendering (æ¸²æŸ“æ—¶é—´)

2. Memory
   - GC.Alloc (GCåˆ†é…é€Ÿç‡)
   - Total Allocated (æ€»åˆ†é…)
   - Reserved Total (ä¿ç•™å†…å­˜)

3. Rendering
   - Batches (æ‰¹æ¬¡æ•°)
   - Tris/Verts (ä¸‰è§’å½¢/é¡¶ç‚¹æ•°)
   - SetPass calls (çŠ¶æ€åˆ‡æ¢)

4. VR Specific
   - Time.deltaTimeåˆ†å¸ƒç›´æ–¹å›¾
   - GPUå¸§æ—¶é—´
```

### çœŸæœºæµ‹è¯•æµç¨‹

```bash
# 1. æ„å»ºä¼˜åŒ–ç‰ˆæœ¬APK
Unity Editor â†’ Build Settings â†’ Android
- Scripting Backend: IL2CPP
- Target Architectures: ARM64
- Optimization: Size/Speedä¼˜åŒ–

# 2. å®‰è£…åˆ°PICOè®¾å¤‡
adb install -r optimized.apk

# 3. ä½¿ç”¨Unity Profilerè¿œç¨‹åˆ†æ
Unity Editor â†’ Window â†’ Analysis â†’ Profiler
â†’ Playmode â†’ Android â†’ é€‰æ‹©è®¾å¤‡

# 4. æŸ¥çœ‹æ—¥å¿—
adb logcat Unity:I *:S | grep Performance

# 5. æ€§èƒ½è¿½è¸ª
adb shell am start -n com.yourcompany.app/.MainActivity --es "perf" "true"
```

### A/Bæµ‹è¯•å¯¹æ¯”

```
æµ‹è¯•åè®®ï¼š
- æ¯ä¸ªç‰ˆæœ¬æµ‹è¯•5åˆ†é’Ÿ
- è®°å½•3ä¸ªå…³é”®åœºæ™¯çš„æ€§èƒ½
- é‡å¤3æ¬¡å–å¹³å‡å€¼

åœºæ™¯1ï¼šé™æ­¢çŠ¶æ€ï¼ˆå¤´æ˜¾å’Œæ‰‹æŸ„ä¸åŠ¨ï¼‰
åœºæ™¯2ï¼šæ­£å¸¸æ“ä½œï¼ˆç¼“æ…¢ç§»åŠ¨ï¼‰
åœºæ™¯3ï¼šå¿«é€Ÿç§»åŠ¨ï¼ˆå‹åŠ›æµ‹è¯•ï¼‰
```

---

## æ€»ç»“

### ç«‹å³å®æ–½ï¼ˆP0ï¼‰

1. **DataTrackingå‘é€é¢‘ç‡é™åˆ¶åˆ°30Hz** - é¢„è®¡æå‡CPU 50%
2. **HapticMessageReceiveré™ä½è½®è¯¢é¢‘ç‡** - é¢„è®¡å‡å°‘ç½‘ç»œå¼€é”€ 70%
3. **VRLogDisplayæ‰¹å¤„ç†æ›´æ–°** - é¢„è®¡å‡å°‘GCåˆ†é… 80%

### çŸ­æœŸä¼˜åŒ–ï¼ˆP1ï¼‰

4. UIControllerå‚æ•°æ£€æµ‹ä¼˜åŒ–
5. URLå­—ç¬¦ä¸²ç¼“å­˜
6. çº¹ç†æ›´æ–°æ— é”åŒ–

### é•¿æœŸæ”¹è¿›ï¼ˆP2ï¼‰

7. æ¶æ„é‡æ„ï¼ˆå•ä¾‹/ä¾èµ–æ³¨å…¥ï¼‰
8. å†…å­˜æ± åŒ–
9. æ¡ä»¶ç¼–è¯‘æ¸…ç†

### é¢„æœŸæ€»ä½“æå‡

```
å¸§ç‡ç¨³å®šæ€§ï¼šâ†‘ 90%ï¼ˆæœ€å…³é”®æŒ‡æ ‡ï¼‰
CPUå ç”¨ï¼šâ†“ 40%
GCå‹åŠ›ï¼šâ†“ 75%
ç½‘ç»œå¸¦å®½ï¼šâ†“ 65%
ç”µæ± å¯¿å‘½ï¼šâ†‘ 30%
```

---

**å»ºè®®ï¼š** å…ˆå®æ–½P0ä¼˜å…ˆçº§çš„3ä¸ªä¼˜åŒ–ï¼ŒéªŒè¯æ•ˆæœåå†æ¨è¿›P1/P2ä¼˜åŒ–ã€‚æ¯æ¬¡ä¼˜åŒ–åéƒ½åº”è¯¥ä½¿ç”¨Unity Profilerè¿›è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•ã€‚
